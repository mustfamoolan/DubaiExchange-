# منطق خصم الأرصدة في نظام الصرافة

## وصف النظام
تم تطبيق منطق ذكي لخصم الأرصدة من العملاء والموظفين حسب نوع العملة عند إجراء عمليات الصرف.

## منطق العمل

### 1. عند صرف دينار عراقي (IQD):
- **خصم من رصيد العميل**: يتم خصم المبلغ من `current_iqd_balance` للعميل
- **خصم من رصيد الموظف**: يتم خصم المبلغ من الرصيد النقدي للموظف (naqa + المستلم - المصروف)

### 2. عند صرف دولار أمريكي (USD):
- **خصم من رصيد العميل**: يتم خصم المبلغ من `current_usd_balance` للعميل
- **خصم من رصيد الموظف**: يتم خصم المبلغ من رصيد الدولار للموظف (usd_cash + المستلم بالدولار - المصروف بالدولار)

## التحقق من كفاية الرصيد

### للعملاء:
- يتم التحقق من رصيد العميل حسب العملة المطلوبة قبل إجراء العملية
- إذا كان الرصيد غير كافي، يتم رفض العملية مع رسالة توضيحية

### للموظفين:
- يتم حساب الرصيد الحالي للموظف بدقة حسب العملة
- الرصيد = الرصيد الافتتاحي + إجمالي المستلم - إجمالي المصروف
- إذا كان الرصيد غير كافي، يتم رفض العملية

## الملفات المحدثة

### 1. Backend (PHP/Laravel):
- `app/Http/Controllers/ExchangeController.php`:
  - `getEmployeeCurrentBalance()`: حساب رصيد الموظف حسب العملة
  - `checkCustomerBalance()`: التحقق من رصيد العميل
  - `store()`: معالجة عملية الصرف مع الخصم التلقائي

- `app/Models/ExchangeTransaction.php`:
  - إضافة حقل `currency_type` للتمييز بين العملات

- `database/migrations/2025_08_14_141953_add_currency_type_to_exchange_transactions_table.php`:
  - إضافة حقل العملة لجدول المعاملات

### 2. Frontend (React/JavaScript):
- `resources/js/Pages/Employee/Exchange.jsx`:
  - تحديث عرض الأرصدة لكلا العملتين
  - تحديث دوال الإرسال لمعالجة الأرصدة المختلفة
  - إضافة state منفصل لكل عملة

## المزايا:
1. **دقة في الحسابات**: كل عملة لها حساب منفصل
2. **منع الأخطاء**: التحقق من كفاية الرصيد قبل العملية
3. **شفافية**: عرض واضح للأرصدة المختلفة
4. **مرونة**: يمكن تطبيق نفس المنطق في صفحات أخرى

## كيفية الاستخدام في صفحات أخرى:

```php
// للتحقق من رصيد الموظف
$currentBalance = $this->getEmployeeCurrentBalance($userId, $currency);

// للتحقق من رصيد العميل  
$hasBalance = $this->checkCustomerBalance($customerId, $amount, $currency);

// تحديث رصيد العميل بعد المعاملة
$customer->updateBalances();
```

## ملاحظات مهمة:
- تم الحفاظ على التوافق مع النظام القديم
- جميع المعاملات تتم داخل transaction لضمان سلامة البيانات
- يتم تحديث أرصدة العملاء تلقائياً بعد كل معاملة
- النظام يدعم كلاً من الدينار العراقي والدولار الأمريكي

---
**تاريخ التطبيق**: 14 أغسطس 2025
**المطور**: GitHub Copilot
**النسخة**: 1.0
